<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
<head>
<title>Memo</title>
<style>
IMG { height: 80px; width: 80px }
</style>
</head>
<body style ="background-color: #f0e000">
<table id="tablica">
</table>
</body>
<script type="text/javascript" src="jquery-1.11.0.js"></script>
<script>
// zmienne ustawiane przez uzytkownika
var tableWidth=4;
var tableHeight=4;

//zmienne, ktore dostaje od serwera
var userId = 0;
var gameInitialized=-1;
var gameStarted = 0;

// wlasne zmienne globalne
var tileNumber=0;
var openTilesCount=0;
var openTiles=[];
var picturesOpen=[];
var address = "../server/new.py";

var latestOpen1=[-1, -1, -1, -1];
var latestOpen2=[-1, -1, -1, -1];


function checkState(){	/*! pierwsza uruchamiana funkcja, sprawdza, czy uzytkownik jest pierwszy i jesli tak, to uruchamia funkcje inicjalizujaca, a jesli nie, to wywolywana jest od razu funkcja rejestrujaca gracza, a nastepnie tworzy sie widok planszy dla gracza*/
var dane = {
		user: userId,
		"function": "checkState",
	};
	
	$.post(address, JSON.stringify(dane), function(data){
		gameInitialized = data.State;
		if(gameInitialized==-1){
			initGame();
		}
		else{
			start();
			makeTable();
		}
	});

}


function endTurn(){		/*! funkcja wysyla do serwera informacje, ze gracz skonczyl swoja ture */
	var end= {
			user: userId,
			"function": "endTurn",
		};
		
		$.post(address, JSON.stringify(end), function(data){console.log(data);});
}


function start(){		/*! funkcja rejestrujaca gracza*/
		if(gameInitialized !== 1){
			var imie = prompt("Podaj imie");
			var dane = {
				user: userId,
				"function": "addPlayer",
				name: imie,
			};
			
			$.post(address, JSON.stringify(dane), function(data){userId = data.user;});
		}
}



function initGame(){	/*! funkcja inicjalizujaca gre, uzytkownik jest proszony o podanie wymiarow planszy, kiedy gra juz sie zainicjuje wywoluje sie funkcja rejestrujaca, a nastepnie tworzy sie widok planszy dla gracza*/
	tableWidth = prompt("Podaj szerokosc planszy: ");
	var num1 = parseInt(tableWidth);
	tableHeight = prompt("Podaj wysokosc planszy: ");
	var num2 = parseInt(tableHeight);
	
	var dane= {
		'user': userId,
		'function': "initGame",
		columns: num1,
		rows: num2,
	};
	
	if(gameInitialized==-1){
		$.post(address, JSON.stringify(dane), function(data){
			console.log(data);
			start();
			makeTable();
			
		});
	}
	else{
		start();
		makeTable();
	}
}


setInterval(function(){		/*! wywolywana okresowo funkcja sprawdzajaca aktualny stan gry (status, czyja tura, odsloniete plytki, tabela wynikow) */
	var coTam= {
		user: userId,
		"function": "wattsUp",
	};
	
    $.post(address, JSON.stringify(coTam), function(data){
		console.log(data);
		if(data.player != userId){	// to nie nasz tura, trzeba pokazac obrazki
		
		if(data.first[0]>=0 && data.first[1]>=0 && data.first[2]>=0 && data.second[0]>=0 && data.second[1]>=0 && data.second[2]>=0){	//jesli sa dwa obrazki do pokazania
			
			var wspX1 = data.first[0];
			var wspY1 = data.first[1];
			var pict1 = data.first[2];
			
			var wspX2 = data.second[0];
			var wspY2 = data.second[1];
			var pict2 = data.second[2];
			
			var toOpen1 = [wspX1, wspY1, pict1, data.player];
			var toOpen2 = [wspX2, wspY2, pict2, data.player];
			
			if(toOpen1 != latestOpen1 && toOpen2 != latestOpen2){	// nie probujemy otworzyc dokladnie tego, co ostatnio
			
				latestOpen1 = toOpen1;
				latestOpen2 = toOpen2;
				var tile2 = wspX2*tableWidth + wspY2;
				var tile1 = wspX1*tableWidth + wspY1;
				var pierwszy = document.getElementById("k"+(tile1));
				var drugi = document.getElementById("k"+(tile2));
				
				pierwszy.innerHTML = "<img src='"+ pict1 +".jpg'>";
				drugi.innerHTML = "<img src='"+ pict1 +".jpg'>";
				
				if(pict1 == pict2){	// dwa obrazki takie same, zostaja na zawsze
					pierwszy.otwarty = 1;
					drugi.otwarty = 1;
				}
				else{ // dwa obrazki inne, zakryja sie
					setTimeout(function(pierwszy, drugi){pierwszy.innerHTML = "<img src='zakryte.png'>"; drugi.innerHTML = "<img src='zakryte.png'>";},2500);
				}
			}
		}
	
			
			
		}
	});
},1000);

function checkTile(x, y, td)	/*! funkcja wywolywana, kiedy gracz kliknie na zakryta plytke (a nie ma jeszcze dwoch odkrytych) */
{

	var coTam= {
		user: userId,
		"function": "wattsUp",
	};
	
    $.post(address, JSON.stringify(coTam), function(data){	/*! zapytanie serwera, czy to tura danego gracza */
		if(data.player != userId){
			alert("To nie Twoja tura!");
		}
		else{		/* nasza tura, mozna sprawdzac */
			var tileInfo= {
			user: userId,
			row: x,
			column: y,
			"function": "choose",
			};
		

			$.post(address, JSON.stringify(tileInfo), function(data){	/*! wybor plytki i zapytanie serwera, jaki jest tam obrazek */
			
				console.log(data);
				obrazek = data.picture;
				picturesOpen.push(obrazek);
				td.innerHTML = "<img src='"+ obrazek +".jpg'>";
				td.otwarty = 1;
				openTiles.push(td);
							
				openTilesCount++;
				if(openTilesCount==2){	/* sa otwarte dwa obrazki */
					twoTilesOpen();
								
				}
				
			});
		}
	
	
	});
	

}

function twoTilesOpen()	/*! funkcja wywolywana, kiedy mamy dwa otwarte obrazki - zakrywamy lub zostawiamy */
{
	if(picturesOpen[0]==picturesOpen[1]){
		openTiles[0].otwarty = 1;
		openTiles[1].otwarty = 1;
		openTilesCount--;
		openTiles.pop();
		openTilesCount--;
		openTiles.pop();
		picturesOpen.pop();
		picturesOpen.pop();
		setTimeout(endTurn,2500);
	}
	else{
		setTimeout(closeTiles,2500);
	}
	
	
}

function closeTiles()	/*! funkcja zakrywajaca z powrotem dwie odkryte plytki */
{
	for(i=openTiles.length-1; i>=0; i--){
	
		openTiles[i].innerHTML = "<img src='zakryte.png'>";
		openTiles[i].otwarty = 0;
		openTilesCount--;
		openTiles.pop();
		picturesOpen.pop();
	}
	endTurn();
}

function makeTd(tr)		/*! funkcja tworzaca plytki	 */
{
	var td = document.createElement("td");
	td.innerHTML = "<img src='zakryte.png'>";
	td.setAttribute("id", "k"+(tileNumber));
	td.otwarty = 0;
	td.number = tileNumber;
	tileNumber = tileNumber + 1;
	td.onclick = function(){
		if(openTilesCount<2){		// mozna odkrywac
			if(td.otwarty == 0){	// obrazek zakryty
				var kolumna = td.number % tableWidth;
				var rzad = (td.number - kolumna)/tableWidth;
				checkTile(rzad, kolumna, td);
				
			
			}
		
		}
	}
	tr.appendChild(td);
}

function makeTable()	/*! funkcja tworzaca plansze i wypelniajaca ja plytkami */
{
	var table = document.getElementById("tablica");
	var dane = {
		user: userId,
		"function": "getSize",
	};
	
	$.post(address, JSON.stringify(dane), function(data){
		tableWidth = data.sizeX;
		tableHeight = data.sizeY;
	
		for(i=1; i<=tableHeight; i++)
		{
			var tr = document.createElement("tr"); //zrob <tr>
			for(j=1; j<=tableWidth; j++)
			{
				makeTd(tr);
			}
			table.appendChild(tr);
		}
	});
}

// koniec deklaracji, poczatek wywolan


checkState();


</script>

</html>